#!/bin/bash

me="$(readlink -f "$0")"
timeout=600
notify=$((timeout / 30))

op="$1"

if [[ -z "$op" ]]; then
	op="start"
fi

configure() {
	xset s $((timeout - notify)) $notify
	xset dpms $((timeout * 2)) $((timeout * 22 / 10)) $((timeout * 24 / 10))
}

dimmer() {
	systemctl --user "$op" xss-dimmer@${notify}.service
}

postlock() {
	pactl -- set-sink-mute @DEFAULT_SINK@ off
	pactl -- set-source-mute @DEFAULT_SOURCE@ off
	dunstctl set-paused false
	i3-msg "mode default"
}

prelock() {
	i3-msg "mode locked"
	playerctl -a pause
	pactl -- set-sink-mute @DEFAULT_SINK@ on
	pactl -- set-source-mute @DEFAULT_SOURCE@ on
	dunstctl set-paused true
}

case "$op" in
start)
	configure
	exec xss-lock --notifier="$me notify" --transfer-sleep-lock "$me" lock
	;;
dim | notify)
	echo "notify: start"
	trap 'echo notify: user activity; dimmer stop; kill %% 2> /dev/null; exit 0' HUP # user activity
	trap 'echo notify: locker started; kill %% 2> /dev/null; exit 0' TERM            # locker started
	dimmer start
	sleep infinity &
	wait
	echo "notify: end"
	;;
lock)
	echo "lock: lock screen"
	# Something may have meddled with screensaver settings
	configure
	# Lock screen
	prelock
	betterlockscreen -l dim
	postlock
	# Alternative if we prefer videos:
	# XSECURELOCK_SAVER=saver_mpv
	# XSECURELOCK_LIST_VIDEOS_COMMAND="ls -1 ~/.config/i3/wallpapers/*.mp4"
	# xsecurelock
	echo "lock: unlock screen"
	# After unlocking screen, stop dimmer, restore notifications
	dimmer stop
	;;
esac
